<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moschee Drita - Mitgliederverwaltung</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-firestore-compat.js"></script>
    <style>
        /* Your existing CSS styles */
        /* ... */
    </style>
</head>
<body>
    <!-- Your existing HTML content -->
    <!-- ... -->

    <script src="firebaseConfig.js"></script>
    <script>
        // Firebase initialisieren
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const membersCollection = db.collection("members");
        const financeCollection = db.collection("finances");

        // Neues Mitglied hinzufügen - Modal öffnen
        // Your existing JavaScript code for adding members
        // ...

        // Mitgliederliste anzeigen
        const membersTable = document.getElementById("members");
        membersCollection.onSnapshot(async (snapshot) => {
            if (snapshot.empty) {
                document.getElementById("loadingMessage").textContent = "Keine Mitglieder gefunden.";
                return;
            }

            membersTable.innerHTML = "";
            document.getElementById("loadingMessage").style.display = "none";
            for (const doc of snapshot.docs) {
                const member = doc.data();
                const tr = document.createElement("tr");
                tr.setAttribute("data-id", doc.id);

                const memberNumberTd = document.createElement("td");
                memberNumberTd.textContent = member.memberNumber;
                tr.appendChild(memberNumberTd);

                const vornameTd = document.createElement("td");
                vornameTd.textContent = member.vorname;
                tr.appendChild(vornameTd);

                const nachnameTd = document.createElement("td");
                nachnameTd.textContent = member.nachname;
                tr.appendChild(nachnameTd);

                const emailTd = document.createElement("td");
                emailTd.textContent = member.email;
                tr.appendChild(emailTd);

                const phoneTd = document.createElement("td");
                phoneTd.textContent = member.phone;
                tr.appendChild(phoneTd);

                const addressTd = document.createElement("td");
                addressTd.textContent = member.address;
                tr.appendChild(addressTd);

                const zipTd = document.createElement("td");
                zipTd.textContent = member.zip;
                tr.appendChild(zipTd);

                const cityTd = document.createElement("td");
                cityTd.textContent = member.city;
                tr.appendChild(cityTd);

                const years = [2022, 2023, 2024, 2025, 2026];
                for (const year of years) {
                    const paymentTd = document.createElement("td");
                    let totalPayment = 0;
                    const financeQuery = await financeCollection.get();
                    financeQuery.forEach((financeDoc) => {
                        const financeData = financeDoc.data();
                        
                        // Überprüfen, ob vorname und nachname definiert sind, bevor toLowerCase angewendet wird
                        const vorname = member.vorname ? member.vorname.toLowerCase() : "";
                        const nachname = member.nachname ? member.nachname.toLowerCase() : "";
                        const note = financeData.note ? financeData.note.toLowerCase() : "";

                        if (
                            note.includes(vorname) && // Unabhängig von Groß-/Kleinschreibung prüfen
                            note.includes(nachname) && // Unabhängig von Groß-/Kleinschreibung prüfen
                            financeData.yearlyFee === year // Überprüfen, ob der Mitgliedsbeitrag für das Jahr zutrifft
                        ) {
                            if (financeData.category === "Mitgliederbeitrag") {
                                totalPayment += parseFloat(financeData.amount);
                            }
                        }
                    });

                    paymentTd.textContent = totalPayment;
                    tr.appendChild(paymentTd);
                }

                const actionsTd = document.createElement("td");
                const editButton = document.createElement("button");
                editButton.textContent = "Bearbeiten";
                editButton.addEventListener("click", () => openEditModal(doc.id, member));
                actionsTd.appendChild(editButton);
                tr.appendChild(actionsTd);

                membersTable.appendChild(tr);
            }
        });

        // Bearbeiten-Modul öffnen
        // Your existing JavaScript code for editing and deleting members
        // ...

        // Mitglieder exportieren (Excel)
        // Your existing JavaScript code for exporting members
        // ...

        // Mitglieder importieren (Excel)
        // Your existing JavaScript code for importing members
        // ...
    </script>
</body>
</html>